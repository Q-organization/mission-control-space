# Task Analysis Pipeline

Automated system that pre-analyzes development tasks when they're created in Notion. Produces ready-to-use Claude Code prompts so developers can start working immediately without explaining context.

## How It Works

```
┌──────────────────────────────────────────────────────────────────────┐
│  NOTION                                                              │
│  Task created with "Auto Analyze" ✅                                 │
│  Fields: Ticket, Description, Type, Priority, Auto Analyze           │
└──────────────────┬───────────────────────────────────────────────────┘
                   │ Notion automation (webhook on page edit)
                   ▼
┌──────────────────────────────────────────────────────────────────────┐
│  SUPABASE EDGE FUNCTION: notion-webhook                              │
│                                                                      │
│  1. Creates/updates planet as usual                                  │
│  2. Generates Quick Prompt (template from task metadata)             │
│  3. Saves quick_prompt to notion_planets table                       │
│  4. Writes Quick Prompt back to Notion page                          │
│  5. If Auto Analyze is ON → triggers GitHub Actions workflow         │
└──────────────────┬──────────────────────┬────────────────────────────┘
                   │                      │
          (instant)│                      │ (if Auto Analyze checked)
                   ▼                      ▼
┌─────────────────────────┐  ┌─────────────────────────────────────────┐
│  NOTION PAGE            │  │  GITHUB ACTIONS: analyze-task.yml        │
│  "Quick Prompt" field   │  │                                          │
│  filled instantly       │  │  1. Checks out ALL 11 repos              │
└─────────────────────────┘  │  2. Loads analysis-agent-prompt.md       │
                             │  3. Runs claude -p (Sonnet, $1 budget)   │
                             │  4. Claude reads CLAUDE.md files,        │
                             │     searches codebase, finds files,      │
                             │     produces implementation plan         │
                             │  5. Posts analysis to callback function   │
                             └──────────────────┬──────────────────────┘
                                                │ ~2-5 minutes
                                                ▼
                             ┌─────────────────────────────────────────┐
                             │  SUPABASE EDGE FUNCTION:                 │
                             │  task-analysis-callback                  │
                             │                                          │
                             │  1. Saves analysis to notion_planets     │
                             │     .deep_analysis column                │
                             │  2. Writes to Notion "Deep Analysis"     │
                             │     field                                │
                             └─────────────────────────────────────────┘
```

## Two Levels of Analysis

### Quick Prompt (instant, every task)

Generated by the webhook from task metadata. Template-based, no AI involved, zero cost.

**Example output:**
```
Task: Fix rating scale score filter bug
Type: bug | Priority: high

Description:
When a user creates a score with rating scale ranges, all ranges match instead of just the correct one.

Instructions:
1. Read the CLAUDE.md in the relevant repository to understand the project structure and conventions
2. Search the codebase for files related to this task
3. Read the relevant source files and understand the current behavior
4. Propose the required changes
5. Implement after approval
```

**Stored in:** `notion_planets.quick_prompt` + Notion "Quick Prompt" field

### Deep Analysis (on-demand, costs ~$0.10-0.50 per task)

Full codebase analysis by Claude Code running in GitHub Actions. Checks out all 11 repositories, reads CLAUDE.md files, searches for relevant code, identifies exact files and line numbers, and produces a detailed implementation plan with a ready-to-paste prompt.

**Triggered when:** "Auto Analyze" checkbox is checked in Notion

**Example output:**
```
## Repository
UniqueQuizzSaasBackend — the filter evaluation logic is in the backend service layer.

## Key Files
- src/filter/filter.service.ts — evaluateCondition() method at line 42, handles operation matching
- src/score/score.service.ts — computeScore() calls filter evaluation for each rule

## Current Behavior
The switch statement in evaluateCondition() has a case for 'equals' but not 'equal'.
The frontend sends operation: 'equal' (no 's'). Since 'equal' doesn't match any case,
it falls through to default: return true — every rule passes.

## Required Changes
1. Add 'equal' as a fallthrough case before 'equals' in filter.service.ts:42
2. Add number type coercion when filter.type === 'number'

## Ready-to-Use Prompt
[Complete prompt ready to paste into Claude Code]
```

**Stored in:** `notion_planets.deep_analysis` + Notion "Deep Analysis" field

## Notion Configuration

### Required Properties

| Property | Type | Purpose |
|----------|------|---------|
| `Auto Analyze` | Checkbox | Toggle to trigger deep analysis |
| `Quick Prompt` | Text | Auto-filled with template prompt |
| `Deep Analysis` | Text | Auto-filled with codebase analysis |

These are in addition to the existing properties (Ticket, Description, Status, Priority, What is it?, Attributed to, Due Date, Créé par).

### Notion Automation

The existing "When page is edited" automation handles everything. No new automations needed — the webhook parses the Auto Analyze checkbox from the same payload.

## Database Schema

Three columns added to `notion_planets` table:

```sql
ALTER TABLE notion_planets ADD COLUMN quick_prompt TEXT;
ALTER TABLE notion_planets ADD COLUMN deep_analysis TEXT;
ALTER TABLE notion_planets ADD COLUMN auto_analyze BOOLEAN DEFAULT false;
```

Migration: `supabase/migrations/20260210000000_add_task_analysis_columns.sql`

## API Calls & Edge Functions

### notion-webhook (modified)

**Endpoint:** `POST https://qdizfhhsqolvuddoxugj.supabase.co/functions/v1/notion-webhook`

**New behavior added:**
1. Parses `Auto Analyze` checkbox from `props['Auto Analyze']?.checkbox`
2. After creating/updating planets, generates quick prompt via `generateQuickPrompt()`
3. Saves `quick_prompt` and `auto_analyze` to all planets for the task
4. Writes quick prompt to Notion via `PATCH /v1/pages/{page_id}` (Notion API)
5. If `auto_analyze === true` and planet was just created, triggers GitHub Actions

**GitHub Actions trigger call:**
```
POST https://api.github.com/repos/Q-organization/mission-control-space/actions/workflows/analyze-task.yml/dispatches
Authorization: Bearer {GITHUB_PAT}
Content-Type: application/json

{
  "ref": "main",
  "inputs": {
    "task_title": "Fix rating scale bug",
    "task_description": "When a user creates a score...",
    "task_type": "bug",
    "task_priority": "high",
    "notion_planet_id": "uuid-of-planet-in-supabase",
    "notion_task_id": "uuid-of-notion-page"
  }
}
```

**Response:** `204 No Content` on success (GitHub API standard for dispatches)

### task-analysis-callback

**Endpoint:** `POST https://qdizfhhsqolvuddoxugj.supabase.co/functions/v1/task-analysis-callback`

**JWT:** Disabled (deployed with `--no-verify-jwt`)

**Request:**
```json
{
  "notion_planet_id": "uuid-of-planet-in-supabase",
  "notion_task_id": "uuid-of-notion-page",
  "analysis": "## Repository\nUniqueQuizzSaasBackend..."
}
```

**What it does:**
1. Updates `notion_planets.deep_analysis` with the analysis text
2. Writes analysis to Notion page "Deep Analysis" property via Notion API
3. Notion rich_text has a 2000 char limit — analysis is truncated if longer

**Response:**
```json
{
  "success": true,
  "notion_planet_id": "uuid",
  "analysis_length": 1847
}
```

**Notion API call made by this function:**
```
PATCH https://api.notion.com/v1/pages/{notion_task_id}
Authorization: Bearer {NOTION_API_TOKEN}
Notion-Version: 2022-06-28

{
  "properties": {
    "Deep Analysis": {
      "rich_text": [{
        "type": "text",
        "text": { "content": "## Repository\n..." }
      }]
    }
  }
}
```

## GitHub Actions Workflow

**File:** `.github/workflows/analyze-task.yml`

**Trigger:** `workflow_dispatch` with inputs (called by the webhook)

**What it does:**
1. Checks out 11 repositories from Q-organization into `workspace/` directory
2. Installs Claude Code (`npm install -g @anthropic-ai/claude-code`)
3. Runs `claude -p` in headless mode with:
   - `--dangerously-skip-permissions` (CI environment, no user to approve)
   - `--no-session-persistence` (don't save session data)
   - `--max-budget-usd 1.00` (cost cap per analysis)
   - `--model sonnet` (Claude Sonnet — fast, cheaper, good for analysis)
   - `--allowedTools "Read Glob Grep"` (read-only, cannot write files)
   - `--append-system-prompt` loaded from `.github/analysis-agent-prompt.md`
4. Saves output to `/tmp/analysis.txt`
5. POSTs analysis to `task-analysis-callback` edge function

**Repositories checked out:**

| Repository | Path in workspace |
|------------|-------------------|
| UniqueQuizzSaas | `workspace/UniqueQuizzSaas/` |
| UniqueQuizzSaasBackend | `workspace/UniqueQuizzSaasBackend/` |
| UniqueQuizzForms | `workspace/UniqueQuizzForms/` |
| UniqueQuizzHulkSmash | `workspace/UniqueQuizzHulkSmash/` |
| UniqueQuizzAnalyticsBackend | `workspace/UniqueQuizzAnalyticsBackend/` |
| UniqueQuizzPrisma | `workspace/UniqueQuizzPrisma/` |
| UniqueQuizzAutomations | `workspace/UniqueQuizzAutomations/` |
| UniqueQuizzMonitoring | `workspace/UniqueQuizzMonitoring/` |
| Landing-Page | `workspace/Landing-Page/` |
| HulkSmashVideo | `workspace/HulkSmashVideo/` |
| mission-control-space | `workspace/mission-control-space/` |

**Timeout:** 10 minutes

### Analysis Agent Prompt

**File:** `.github/analysis-agent-prompt.md`

The system prompt loaded into Claude's context. It tells Claude:
- It's read-only — never modify files
- 99% of tasks are frontend in UniqueQuizzSaas
- How to identify the correct repo from task keywords
- To read CLAUDE.md files first
- To check backend APIs and Prisma schema for context
- Exact output format: Repository, Key Files, Current Behavior, Required Changes, Ready-to-Use Prompt

Edit this file to change how the analysis agent behaves — no workflow changes needed.

## Secrets & Environment Variables

### GitHub Secrets (in mission-control-space repo settings)

| Secret | Used by | Purpose |
|--------|---------|---------|
| `ANTHROPIC_API_KEY` | analyze-task workflow | Claude Code API access |
| `GH_PAT` | analyze-task workflow | Checkout private repos |
| `AWS_ACCESS_KEY_ID` | deploy workflow | S3 deployment (existing) |
| `AWS_SECRET_ACCESS_KEY` | deploy workflow | S3 deployment (existing) |

### Supabase Secrets (edge function env vars)

| Secret | Used by | Purpose |
|--------|---------|---------|
| `GITHUB_PAT` | notion-webhook | Trigger GitHub Actions workflow |
| `NOTION_API_TOKEN` | notion-webhook, task-analysis-callback | Write prompts to Notion pages |
| `SUPABASE_URL` | All edge functions | Supabase connection |
| `SUPABASE_SERVICE_ROLE_KEY` | All edge functions | Bypass RLS |

**Set Supabase secrets via CLI:**
```bash
npx supabase secrets set GITHUB_PAT=github_pat_xxx
```

## Cost

- **Quick Prompt:** Free (template-based, no AI)
- **Deep Analysis:** ~$0.10-0.50 per task (Claude Sonnet, capped at $1.00)
- **GitHub Actions:** Free for public repos, counted against plan minutes for private repos
- **Toggle:** Only tasks with "Auto Analyze" checked trigger the paid analysis

## Files

| File | Purpose |
|------|---------|
| `.github/workflows/analyze-task.yml` | GitHub Actions workflow |
| `.github/analysis-agent-prompt.md` | System prompt for the analysis agent |
| `supabase/functions/notion-webhook/index.ts` | Webhook (generates quick prompt, triggers analysis) |
| `supabase/functions/task-analysis-callback/index.ts` | Receives and stores deep analysis |
| `supabase/migrations/20260210000000_add_task_analysis_columns.sql` | Database migration |
| `docs/task-analysis-pipeline.md` | This documentation |

## Debugging

### Quick Prompt not appearing in Notion
1. Check Supabase logs for `notion-webhook` function
2. Look for: `Saved quick prompt for "Task Name"`
3. If Notion write fails, look for: `Failed to write quick prompt to Notion`
4. Verify `NOTION_API_TOKEN` is set in Supabase secrets
5. Verify the "Quick Prompt" property exists in Notion database (type: Text)

### Deep Analysis not triggering
1. Check webhook logs for: `Triggered deep analysis for "Task Name"`
2. If `No GITHUB_PAT configured` → set the Supabase secret
3. If `Failed to trigger deep analysis: 404` → the workflow file isn't on the `main` branch yet (push it)
4. If `Failed to trigger deep analysis: 422` → check that workflow inputs match what the webhook sends
5. Check GitHub Actions tab: `https://github.com/Q-organization/mission-control-space/actions`

### Deep Analysis triggered but no result
1. Check GitHub Actions run logs for errors
2. Common issues:
   - `ANTHROPIC_API_KEY` not set as GitHub secret
   - `GH_PAT` doesn't have access to all repos
   - Budget exceeded ($1.00 cap) — increase `--max-budget-usd` in workflow
   - Timeout (10 min) — increase `timeout-minutes` in workflow
3. Check callback logs in Supabase for `task-analysis-callback`

### Testing manually

**Trigger analysis for an existing planet:**
```bash
# Via GitHub Actions UI
# Go to: https://github.com/Q-organization/mission-control-space/actions/workflows/analyze-task.yml
# Click "Run workflow" and fill in the inputs

# Via GitHub API
curl -X POST \
  "https://api.github.com/repos/Q-organization/mission-control-space/actions/workflows/analyze-task.yml/dispatches" \
  -H "Authorization: Bearer YOUR_GITHUB_PAT" \
  -H "Accept: application/vnd.github.v3+json" \
  -d '{
    "ref": "main",
    "inputs": {
      "task_title": "Test task",
      "task_description": "Testing the analysis pipeline",
      "task_type": "enhancement",
      "task_priority": "low",
      "notion_planet_id": "PLANET_UUID_FROM_SUPABASE",
      "notion_task_id": "NOTION_PAGE_UUID"
    }
  }'
```

**Test callback function directly:**
```bash
curl -X POST \
  "https://qdizfhhsqolvuddoxugj.supabase.co/functions/v1/task-analysis-callback" \
  -H "Content-Type: application/json" \
  -d '{
    "notion_planet_id": "PLANET_UUID",
    "notion_task_id": "NOTION_PAGE_UUID",
    "analysis": "## Repository\nTest analysis content"
  }'
```
